<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../shared/css/styles.css">
    <style>
        .balance-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .balance-info {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .balance-item {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .balance-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        .balance-label {
            color: #6c757d;
            font-size: 16px;
        }
        .token-details {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .token-details p {
            margin: 5px 0;
            font-family: monospace;
        }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .user-type-selector {
            margin-bottom: 20px;
        }
        .user-type-selector select {
            font-size: 16px;
            border: 1px solid #ddd;
            width: 200px;
        }
        .verification-status {
            text-align: left;
            font-size: 18px;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .verification-status.valid {
            background-color: #d4edda;
            color: #155724;
        }
        .verification-status.invalid {
            background-color: #f8d7da;
            color: #721c24;
        }
        .distribution-stats {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 5px 0;
        }
        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }
        .loading {
            display: none;
            margin: 20px 0;
            text-align: center;
            color: #666;
        }
        .loading.active {
            display: block;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
    <title>Check Balance - Blockchain Ticketing System</title>
</head>
<body>
    <div class="nav-container"></div>

    <div class="container">
        <div class="card">
            <h1>Check Balance</h1>
            
            <div class="form-group">
                <label for="walletAddress">Wallet Address:</label>
                <input type="text" id="walletAddress" placeholder="Enter wallet address">
            </div>

            <div class="form-group">
                <label>User Type:</label>
                <select id="userType">
                    <option value="attendee">Event Attendee</option>
                    <option value="doorman">Doorman</option>
                    <option value="venue">Venue</option>
                </select>
            </div>

            <div class="loading" id="loading">Initializing Web3...</div>
            <button id="checkBalanceBtn" onclick="checkBalance()" disabled>Check Balance</button>

            <div id="balanceInfo" class="card" style="display: none;">
                <h2>Balance Information</h2>
                <div id="balanceDetails"></div>
            </div>
        </div>
    </div>

    <!-- Add Web3 library -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <!-- Then load our configuration -->
    <script src="../shared/js/web3-config.js"></script>
    <script src="../shared/js/nav.js"></script>
    <script>
        // Show loading state while initializing
        const loadingDiv = document.getElementById('loading');
        const checkBalanceBtn = document.getElementById('checkBalanceBtn');
        loadingDiv.classList.add('active');

        // Initialize Web3 and enable button when ready
        window.addEventListener('load', async function() {
            try {
                const { web3: w3, ticketToken: tt, ticketSales: ts } = await initWeb3();
                window.web3 = w3;
                window.ticketToken = tt;
                window.ticketSales = ts;
                
                // Enable button and hide loading
                checkBalanceBtn.disabled = false;
                loadingDiv.classList.remove('active');
                console.log('Web3 initialized successfully');
            } catch (error) {
                console.error('Error initializing Web3:', error);
                loadingDiv.textContent = 'Error initializing Web3. Please refresh the page.';
            }
        });

        // Make checkBalance function globally accessible
        window.checkBalance = async function() {
            if (!window.web3) {
                alert('Web3 is not initialized yet. Please wait...');
                return;
            }

            const address = document.getElementById('walletAddress').value;
            const userType = document.getElementById('userType').value;

            if (!address) {
                alert('Please enter a wallet address');
                return;
            }

            if (!window.web3.utils.isAddress(address)) {
                alert('Invalid wallet address!');
                return;
            }

            try {
                // Show loading state
                checkBalanceBtn.disabled = true;
                loadingDiv.textContent = 'Checking balance...';
                loadingDiv.classList.add('active');

                const [sethBalance, ticketBalance] = await Promise.all([
                    window.web3.eth.getBalance(address),
                    window.ticketToken.methods.balanceOf(address).call()
                ]);

                const balanceInfo = document.getElementById('balanceInfo');
                const detailsDiv = document.getElementById('balanceDetails');
                balanceInfo.style.display = 'block';

                let html = `
                    <p><strong>SETH Balance:</strong> ${window.web3.utils.fromWei(sethBalance, 'ether')} SETH</p>
                    <p><strong>Ticket Balance:</strong> ${ticketBalance} tickets</p>
                `;

                if (userType === 'doorman') {
                    html += `
                        <p><strong>Verification Status:</strong> 
                            ${ticketBalance > 0 ? 'Valid Ticket Holder' : 'No Tickets Found'}
                        </p>
                    `;
                } else if (userType === 'venue') {
                    const totalSupply = await window.ticketToken.methods.totalSupply().call();
                    html += `
                        <p><strong>Total Tickets in Circulation:</strong> ${totalSupply}</p>
                        <p><strong>Percentage of Total Supply:</strong> 
                            ${((ticketBalance / totalSupply) * 100).toFixed(2)}%
                        </p>
                    `;
                }

                detailsDiv.innerHTML = html;

            } catch (error) {
                alert('Error checking balance: ' + error.message);
            } finally {
                // Reset loading state
                checkBalanceBtn.disabled = false;
                loadingDiv.classList.remove('active');
            }
        };
    </script>
</body>
</html> 